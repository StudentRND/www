{% extends "template.twig" %}
{% block section %}donate{% endblock %}
{% block page %}donate{% endblock %}
{% block title %}Donate{% endblock %}
{% block header %}
    <header>
        <section class="content">
            <h1><a href="/">StudentRND</a></h1>
            <nav><ul></ul></nav>
        </section>
    </header>
{% endblock %}
{% block hero %}
    <section class="title">
        <article>
            <h2>Help us build the future of StudentRND</h2>
        </article>
    </section>
{% endblock %}
{% block content %}
    {% if errors and errors|length > 0 %}
        <section class="error">
            {% for error in errors %}
                {{ error }}{% if errors|length > 0 %}<br />{% endif %}
            {% endfor %}
        </section>
    {% endif %}
    <form class="contribution-info" id="donate-form" method="post">
        <nav class="steps">
            <ul>
                <li {% if not amount %}class="active"{% endif %}><a href="#" data-for="donation">1. Donation Amount</a></li>
                <li {% if amount %}class="active"{% endif %}><a href="#" data-for="donor">2. Donor Information</a></li>
                <li><a href="#" data-for="payment">3. Complete Donation</a></li>
            </ul>
        </nav>

        <section class="donation" {% if amount %}style="display: none"{% endif %}>
            <h2>Donation Amount</h2>

            <div class="amount">
                {% set donation_options = [10, 25, 50, 100, 250, 500, 1000] %}
                {% if amount %}
                    {% set default_donation = amount %}
                {% else %}
                    {% set default_donation = 100 %}
                {% endif %}
                {% for donation_option in donation_options %}
                    <input type="radio" name="amount" id="amount_{{ donation_option }}" value="{{ donation_option }}"
                           {% if default_donation == donation_option %}checked{% endif %} />
                    <label for="amount_{{ donation_option }}">${{ donation_option|number_format(0) }}</label>
                {% endfor %}
                <input type="text" name="amount" id="amount_custom" placeholder="Custom"
                       format="[0-9]*"
                       oninvalid="setCustomValidity('Please enter a number')"
                        {% if not (default_donation in donation_options) %}value="{{ amount }}" class="checked"{% endif %}/>
            </div>
        </section>

        <section class="donor" {% if not amount %}style="display: none"{% endif %}>
            <h2>Donor Information</h2>

            <div class="name">
                <input type="text" name="first_name" id="first_name" placeholder="First Name" value="{{ first_name }}" required/>
                <input type="text" name="last_name" id="last_name" placeholder="Last Name" value="{{ last_name }}" required/>
            </div>
            <input type="email" name="email" id="email" placeholder="Email" value="{{ email }}" required/>

            <div class="address">
                <input type="text" name="address_1" id="address_1" placeholder="Address" value="{{ address_1 }}" required />
                <input type="text" name="address_2" id="address_2" placeholder="Address (continued)" value="{{ address_2 }}" />

                <div class="units">
                    <input type="text" name="city" id="city" placeholder="City" value="{{ city }}" required />
                    <input type="text" name="state" id="state" placeholder="State" value="{{ state }}" required />
                    <input type="text" name="zip" id="zip" placeholder="Postal Code" value="{{ zip }}" required />
                </div>
            </div>

            <div class="option">
                <input type="checkbox" name="is_anonymous" id="is_anonymous" value="1" {% if is_anonymous %}checked{% endif %} />
                <label for="is_anonymous">Keep this donation anonymous. (The above information is still required for tax purposes.)</label>
            </div>
            {% if show_opt_out or opt_out %}
                <div class="option">
                    <input type="checkbox" name="opt_out" id="opt_out" value="1" {% if opt_out %}checked{% endif %} />
                    <label for="opt_out">Please don't ask me to donate again</label>
                </div>
            {% endif %}

            <a class="next-step" href="#" data-for="payment">Next</a>
        </section>

        <section class="payment" style="display: none">
            <h2>Payment Information</h2>
            <div class="onsite-gateway">
                <div class="card">
                    <input type="text" id="card_number" placeholder="Card Number" data-stripe="number" />
                    <div class="exp">
                        <label for="exp">EXP</label>
                        <input type="text" id="exp" placeholder="MM/YYYY" />
                    </div>
                </div>
                <button type="submit" name="payment_method" id="card" value="stripe">Donate ${{ default_donation|number_format(0) }} by card</button>
            </div>
            <div class="alternate-gateways">
                <p>Or</p>
                <button type="submit" name="payment_method" id="dwolla" value="dwolla" class="gateway-dwolla">Donate ${{ default_donation|number_format(0) }} with Dwolla</button>
            </div>
            <div class="mail">
                <p>You can also donate by mailing a check to <strong>505 Broadway E, Box 141, Seattle WA 98102</strong>.</p>
                <p>Want to make a large donation or donate stocks? Contact us at <a href="mailto:donors@studentrnd.org">donors@studentrnd.org</a>.</p>
            </div>
        </section>
    </form>

    <section class="details">
        <img src="/assets/img/donate-why.jpg" alt="Why Donate?"/>
        <div class="why">
            <p>Your donation inspires students nationwide to love coding.</p>
            <p>StudentRND is a 501(c)(3) non-profit. All donations are tax-deductible.</p>
        </div>
    </section>
{% endblock %}
{% block scripts %}
    <script type="text/javascript" src="https://js.stripe.com/v2/"></script>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery.payment/1.0.2/jquery.payment.min.js"></script>
    <script type="text/javascript">
        $(document).ready(function(){
            var switchToStep = function(for_elem) {
                $form = $('#donate-form');
                var visible_elem = $form.children('section:visible').first();

                if (for_elem[0] == visible_elem[0]) {
                    return;
                }

                $form.find('nav li').removeClass('active');
                $form.find('nav li a[data-for="'+for_elem.attr('class')+'"]').parent().addClass('active');

                visible_elem.hide(1000);
                for_elem.show(1000);
            };

            $('nav.steps ul li a, .next-step').on('click', function(e) {
                e.preventDefault();

                var $this = $(this);
                var $form = $this.parents('form');

                switchToStep($form.children('.'+$this.attr('data-for')).first());

                return false;
            });

            $('#donate-form input').on('invalid', function(){
                var $this = $(this);

                switchToStep($this.parents('section').first())
            });

            var formatMoney = function(n, decPlaces, thouSeparator, decSeparator) {
                var decPlaces = isNaN(decPlaces = Math.abs(decPlaces)) ? 2 : decPlaces,
                    decSeparator = decSeparator == undefined ? "." : decSeparator,
                    thouSeparator = thouSeparator == undefined ? "," : thouSeparator,
                    sign = n < 0 ? "-" : "",
                    i = parseInt(n = Math.abs(+n || 0).toFixed(decPlaces)) + "",
                    j = (j = i.length) > 3 ? j % 3 : 0;
                return sign + (j ? i.substr(0, j) + thouSeparator : "") + i.substr(j).replace(/(\d{3})(?=\d)/g, "$1" + thouSeparator) + (decPlaces ? decSeparator + Math.abs(n - i).toFixed(decPlaces).slice(2) : "");
            };

            var updateDonateLabels = function(new_amount){
                $('#card').text('Donate $'+formatMoney(new_amount, 0)+' by card');
                $('#dwolla').text('Donate $'+formatMoney(new_amount, 0)+' with Dwolla');
            };



            $('.amount input[type="radio"]').on('change', function(){
                $('#amount_custom').val('').removeClass('checked');
                updateDonateLabels($(this).val());
                switchToStep($('#donate-form section.donor'));
            });
            $('.amount label').on('click', function(){
                switchToStep($('#donate-form section.donor'));
            });
            var last_checked_radio = null;
            $('#amount_custom').on('click', function(){
                $(this).addClass('checked');
                var checked_radio = $('.amount input[type="radio"]:checked');
                if (checked_radio.length) {
                    last_checked_radio = checked_radio;
                    last_checked_radio.prop('checked', false);
                }
            });
            $('#amount_custom').on('blur', function(){
                if (!$(this).val() || isNaN($(this).val())) {
                    $(this).val('').removeClass('checked');
                    last_checked_radio.prop('checked', true);
                } else {
                    updateDonateLabels($(this).val());
                    switchToStep($('#donate-form section.donor'));
                }
            });

            $('#card_number').payment('formatCardNumber');
            $('#exp').payment('formatCardExpiry');

            Stripe.setPublishableKey('{{ stripe_public|escape('js') }}');
            $('#donate-form').submit(function(e) {
                var $form = $(this);

                if (!$('#amount_custom').val()) {
                    $('#amount_custom').attr('name', '');
                } else {
                    $('#amount_custom').attr('name', 'amount');
                }

                if ($('input[name="amount"]').last().val() < 1) {
                    alert('Donation must be at least $1');
                    return false;
                }

                if (e.originalEvent.explicitOriginalTarget.id == 'dwolla') {
                    $form.append($('<input type="hidden" name="payment_method" />').val('dwolla'));
                    return true;
                } else {
                    e.preventDefault();
                    $form.find('button').prop('disabled', true);

                    var exp = $("#exp").payment("cardExpiryVal");
                    $form.append($('<input type="hidden" data-stripe="exp_month" />').val(exp.month));
                    $form.append($('<input type="hidden" data-stripe="exp_year" />').val(exp.year));

                    Stripe.card.createToken($form, function (status, response) {
                        if (response.error) {
                            alert(response.error.message);
                            $form.find('button').prop('disabled', false);
                        } else {
                            var token = response.id;
                            $form.append($('<input type="hidden" name="stripe_token" />').val(token));
                            $form.append($('<input type="hidden" name="payment_method" />').val('stripe'));
                            $form.get(0).submit();
                        }
                    });

                    return false;
                }
            });

        });
    </script>
{% endblock %}